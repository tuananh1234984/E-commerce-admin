<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800">Sản phẩm</h1>
  <button class="btn btn-sm btn-primary shadow-sm" (click)="startCreate()">
    <i class="fas fa-plus fa-sm mr-1"></i> Thêm sản phẩm
  </button>
</div>

<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex justify-content-between align-items-center">
    <h6 class="m-0 font-weight-bold text-primary">Danh sách sản phẩm</h6>
    <input class="form-control form-control-sm w-auto" placeholder="Tìm kiếm..." [(ngModel)]="q" />
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="thead-light">
          <tr>
            <th>Sản phẩm</th>
            <th>SKU</th>
            <th class="text-center">Giá</th>
            <th>Trạng thái (Tồn kho)</th>
            <th>Trạng thái (Kinh doanh)</th>
            <th class="text-right">Thao tác</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of filteredProducts(); trackBy: trackByProductId">
            <td>
              <div class="d-flex align-items-center">
                <img [src]="p.imageUrl || placeholderImg" [alt]="p.name" class="mr-3" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                <div>{{ p.name }}</div>
              </div>
            </td>
            <td>{{ p.sku }}</td>
            <td class="text-right">{{ p.price | number }}đ</td>
            <td>
              <span class="badge" [ngClass]="{
                'badge-success': p.stock > 10,
                'badge-warning': p.stock > 0 && p.stock <= 10,
                'badge-danger': p.stock === 0
              }">
                <ng-container *ngIf="p.stock > 10">Còn hàng</ng-container>
                <ng-container *ngIf="p.stock > 0 && p.stock <= 10">Sắp hết ({{p.stock}})</ng-container>
                <ng-container *ngIf="p.stock === 0">Hết hàng</ng-container>
              </span>
            </td>
            <td>
              <span class="badge" [class.badge-primary]="p.status==='active'" [class.badge-secondary]="p.status==='inactive'">
                {{ p.status==='active' ? 'Đang bán' : 'Ngừng bán' }}
              </span>
            </td>
            <td class="text-right">
              <button class="btn btn-sm btn-outline-secondary mr-1" (click)="startEdit(p)" title="Sửa"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" (click)="delete(p)" title="Xóa"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
          <tr *ngIf="filteredProducts().length === 0">
            <td colspan="6" class="text-center p-4">Không tìm thấy sản phẩm nào.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


<div class="modal fade" #productModal tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lq modal-dialog-scrollable"> <div class="modal-content">
      
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        
        <div class="modal-header">
          <h5 class="modal-title" id="productModalLabel">
            {{ editId ? 'Cập nhật sản phẩm' : 'Thêm sản phẩm mới' }}
          </h5>
          <button type="button" class="close" (click)="cancelForm()" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body" style="max-height: 60vh; overflow-y: auto">
          <div class="form-group">
            <label>Tên sản phẩm</label>
            <input type="text" class="form-control" formControlName="name" />
          </div>
          <div class="form-group">
            <label>SKU (Mã)</label>
            <input type="text" class="form-control" formControlName="sku" />
          </div>
          <div class="form-group">
            <label>Danh mục</label>
            <select class="form-control" formControlName="category">
              <option value="" disabled>-- Chọn một danh mục --</option>
              <option *ngFor="let cat of categories$ | async" [value]="cat.name">
                {{ cat.name }}
              </option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Giá (VNĐ)</label>
              <input type="number" class="form-control" formControlName="price" min="0" placeholder="0"/>
            </div>
            <div class="form-group col-md-6">
              <label>Tồn kho</label>
              <input type="number" class="form-control" formControlName="stock" min="0" placeholder="0"/>
            </div>
          </div>
          <div class="form-group">
            <label>Mô tả</label>
            <textarea class="form-control" formControlName="description" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>Ảnh sản phẩm</label>
            <img [src]="form.get('imageUrl')?.value || placeholderImg" alt="Preview" class="img-thumbnail d-block mb-2" style="width: 150px; height: 150px; object-fit: cover;">
            <input type="file" class="form-control-file" (change)="onFileSelected($event)" accept="image/*">
            <input type="text" class="form-control form-control-sm mt-2" formControlName="imageUrl" placeholder="Hoặc dán URL ảnh vào đây">
          </div>
          <div class="form-group">
            <label>Trạng thái kinh doanh</label>
            <select class="form-control" formControlName="status">
              <option value="active">Đang bán</option>
              <option value="inactive">Ngừng bán</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" (click)="cancelForm()">Hủy</button>
          <button class="btn btn-primary" type="submit" [disabled]="form.invalid || uploading">
            <span *ngIf="uploading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            {{ editId ? 'Lưu thay đổi' : 'Thêm mới' }}
          </button>
        </div>
      </form>
      </div>
  </div>
</div>